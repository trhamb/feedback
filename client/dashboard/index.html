<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Feedback Dashboard - SSW</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="dashboard-page">
        <header class="dashboard-header">
            <h1>Feedback Dashboard</h1>
            <div class="user-bar">
                <button type="button" class="dashboard-menu-btn" id="dashboard-menu-btn" aria-expanded="false" aria-controls="dashboard-menu" aria-label="Open menu">Menu</button>
                <div class="user-bar-inner" id="dashboard-menu">
                    <span id="admin-links" style="display:none;">
                        <a href="/" class="btn-download-csv btn-add-staff">Back to Hub</a>
                        <a href="add-staff/" class="btn-download-csv btn-add-staff">Add user</a>
                        <a href="users/" class="btn-download-csv btn-add-staff">Manage users</a>
                        <a href="api-keys/" class="btn-download-csv btn-add-staff">API keys</a>
                    </span>
                    <span id="user-name">—</span>
                    <button type="button" class="logout-btn" id="logout-btn">Sign out</button>
                </div>
            </div>
        </header>

        <div class="dashboard-toolbar">
            <label for="filter-event">Event:</label>
            <select id="filter-event">
                <option value="">All events</option>
            </select>
            <button type="button" class="btn-download-csv" id="download-csv-btn" disabled>Download CSV</button>
        </div>

        <div id="content">
            <div class="dashboard-loading">Loading feedback…</div>
        </div>
    </div>

    <script>
        (function() {
            const contentEl = document.getElementById('content');
            const userNameEl = document.getElementById('user-name');
            const filterEvent = document.getElementById('filter-event');
            const logoutBtn = document.getElementById('logout-btn');
            const downloadCsvBtn = document.getElementById('download-csv-btn');
            // If app is served under a subpath (e.g. /feedback/), set base to that path; otherwise leave empty
            const base = (function() {
                const path = window.location.pathname.replace(/\/$/, '');
                if (path.endsWith('/dashboard')) return path.replace(/\/dashboard$/, '');
                if (path.endsWith('/dashboard/login')) return path.replace(/\/dashboard\/login$/, '');
                return '';
            })();

            function redirectToLogin() {
                window.location.href = base + '/dashboard/login/?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
            }

            async function fetchJson(url, options) {
                const res = await fetch(base + url, { credentials: 'include', ...options });
                if (res.status === 401) {
                    redirectToLogin();
                    throw new Error('Unauthorized');
                }
                return res.json();
            }

            var userBar = document.querySelector('.user-bar');
            var menuBtn = document.getElementById('dashboard-menu-btn');
            var menuPanel = document.getElementById('dashboard-menu');
            if (menuBtn && userBar && menuPanel) {
                menuBtn.addEventListener('click', function() {
                    var open = userBar.classList.toggle('open');
                    menuBtn.setAttribute('aria-expanded', open);
                    menuBtn.textContent = open ? 'Close' : 'Menu';
                    if (open) {
                        var header = document.querySelector('.dashboard-header');
                        if (header) menuPanel.style.top = header.getBoundingClientRect().bottom + 'px';
                    } else {
                        menuPanel.style.top = '';
                    }
                });
                document.addEventListener('click', function(e) {
                    if (!userBar.contains(e.target)) {
                        userBar.classList.remove('open');
                        menuBtn.setAttribute('aria-expanded', 'false');
                        menuBtn.textContent = 'Menu';
                        menuPanel.style.top = '';
                    }
                });
            }

            async function loadMe() {
                const data = await fetchJson('/api/staff/me');
                userNameEl.textContent = data.username || 'Staff';
                if (data.role === 'admin') {
                    document.getElementById('admin-links').style.display = '';
                }
            }

            async function loadFeedback() {
                const data = await fetchJson('/api/feedback');
                return Array.isArray(data) ? data : [];
            }

            function starString(rating) {
                return '★'.repeat(Math.min(5, Math.max(0, rating))) + '☆'.repeat(5 - Math.min(5, Math.max(0, rating)));
            }

            function formatDate(createdAt) {
                if (!createdAt) return '—';
                const d = new Date(createdAt);
                return isNaN(d.getTime()) ? createdAt : d.toLocaleString();
            }

            function escapeHtml(str) {
                if (str == null) return '';
                const s = String(str);
                return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }

            function renderTable(rows) {
                const eventFilter = (filterEvent.value || '').toLowerCase();
                const filtered = eventFilter
                    ? rows.filter(function(r) { return (r.event_name || '').toLowerCase() === eventFilter; })
                    : rows;

                downloadCsvBtn.disabled = filtered.length === 0;
                if (filtered.length === 0) {
                    contentEl.innerHTML = '<div class="dashboard-empty"><p>No feedback to show.</p></div>';
                    return;
                }

                const eventOptions = [...new Set(rows.map(function(r) { return r.event_name || ''; }))].filter(Boolean).sort();
                filterEvent.innerHTML = '<option value="">All events</option>' +
                    eventOptions.map(function(ev) { return '<option value="' + escapeHtml(ev) + '">' + escapeHtml(ev) + '</option>'; }).join('');
                const matchingValue = eventFilter
                    ? (eventOptions.find(function(ev) { return (ev || '').toLowerCase() === eventFilter; }) || '')
                    : '';
                filterEvent.value = matchingValue;

                contentEl.innerHTML = '<div class="feedback-card"><div class="feedback-table-wrap"><table class="feedback-table">' +
                    '<thead><tr><th>Event</th><th>Rating</th><th>Comment</th><th>Date</th></tr></thead><tbody>' +
                    filtered.map(function(row) {
                        return '<tr>' +
                            '<td>' + escapeHtml(row.event_name || '—') + '</td>' +
                            '<td class="rating-cell"><span class="rating-stars" title="' + escapeHtml(row.rating) + '">' + starString(row.rating) + '</span></td>' +
                            '<td class="comment-cell" title="' + escapeHtml(row.comment || '') + '">' + escapeHtml(row.comment || '—') + '</td>' +
                            '<td class="date-cell">' + escapeHtml(formatDate(row.created_at)) + '</td>' +
                            '</tr>';
                    }).join('') +
                    '</tbody></table></div></div>';
            }

            async function init() {
                try {
                    await loadMe();
                } catch (e) {
                    return;
                }

                logoutBtn.addEventListener('click', async function() {
                    try {
                        await fetch(base + '/api/staff/logout', { method: 'POST', credentials: 'include' });
                    } catch (_) {}
                    redirectToLogin();
                });

                filterEvent.addEventListener('change', function() {
                    if (window._feedbackRows) renderTable(window._feedbackRows);
                });

                downloadCsvBtn.addEventListener('click', function() {
                    const rows = window._feedbackRows || [];
                    const eventFilter = (filterEvent.value || '').toLowerCase();
                    const filtered = eventFilter
                        ? rows.filter(function(r) { return (r.event_name || '').toLowerCase() === eventFilter; })
                        : rows;
                    if (filtered.length === 0) return;
                    const headers = ['Event', 'Rating', 'Comment', 'Date'];
                    const escapeCsv = function(val) {
                        const s = String(val == null ? '' : val);
                        if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                        return s;
                    };
                    const csvLines = [headers.map(escapeCsv).join(',')].concat(
                        filtered.map(function(row) {
                            return [
                                escapeCsv(row.event_name),
                                escapeCsv(row.rating),
                                escapeCsv(row.comment),
                                escapeCsv(formatDate(row.created_at))
                            ].join(',');
                        })
                    );
                    const csv = csvLines.join('\r\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = (eventFilter || 'all-events') + '-feedback.csv';
                    a.click();
                    URL.revokeObjectURL(url);
                });

                try {
                    const rows = await loadFeedback();
                    window._feedbackRows = rows;
                    renderTable(rows);
                } catch (e) {
                    contentEl.innerHTML = '<div class="dashboard-error">Failed to load feedback.</div>';
                }
            }

            init();
        })();
    </script>
</body>
</html>
