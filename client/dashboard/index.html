<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Feedback Dashboard - SSW</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="dashboard-page">
        <header class="dashboard-header">
            <h1>Feedback Dashboard</h1>
            <div class="user-bar">
                <span id="user-name">—</span>
                <button type="button" class="logout-btn" id="logout-btn">Sign out</button>
            </div>
        </header>

        <div class="dashboard-toolbar">
            <label for="filter-event">Event:</label>
            <select id="filter-event">
                <option value="">All events</option>
            </select>
        </div>

        <div id="content">
            <div class="dashboard-loading">Loading feedback…</div>
        </div>
    </div>

    <script>
        (function() {
            const contentEl = document.getElementById('content');
            const userNameEl = document.getElementById('user-name');
            const filterEvent = document.getElementById('filter-event');
            const logoutBtn = document.getElementById('logout-btn');
            // If app is served under a subpath (e.g. /feedback/), set base to that path; otherwise leave empty
            const base = (function() {
                const path = window.location.pathname.replace(/\/$/, '');
                if (path.endsWith('/dashboard')) return path.replace(/\/dashboard$/, '');
                if (path.endsWith('/dashboard/login')) return path.replace(/\/dashboard\/login$/, '');
                return '';
            })();

            function redirectToLogin() {
                window.location.href = base + '/dashboard/login/?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
            }

            async function fetchJson(url, options) {
                const res = await fetch(base + url, { credentials: 'include', ...options });
                if (res.status === 401) {
                    redirectToLogin();
                    throw new Error('Unauthorized');
                }
                return res.json();
            }

            async function loadMe() {
                const data = await fetchJson('/api/staff/me');
                userNameEl.textContent = data.username || 'Staff';
            }

            async function loadFeedback() {
                const data = await fetchJson('/api/feedback');
                return Array.isArray(data) ? data : [];
            }

            function starString(rating) {
                return '★'.repeat(Math.min(5, Math.max(0, rating))) + '☆'.repeat(5 - Math.min(5, Math.max(0, rating)));
            }

            function formatDate(createdAt) {
                if (!createdAt) return '—';
                const d = new Date(createdAt);
                return isNaN(d.getTime()) ? createdAt : d.toLocaleString();
            }

            function renderTable(rows) {
                const eventFilter = (filterEvent.value || '').toLowerCase();
                const filtered = eventFilter
                    ? rows.filter(function(r) { return (r.event_name || '').toLowerCase() === eventFilter; })
                    : rows;

                if (filtered.length === 0) {
                    contentEl.innerHTML = '<div class="dashboard-empty"><p>No feedback to show.</p></div>';
                    return;
                }

                const eventOptions = [...new Set(rows.map(function(r) { return r.event_name || ''; }))].filter(Boolean).sort();
                const currentSelect = filterEvent.innerHTML;
                filterEvent.innerHTML = '<option value="">All events</option>' +
                    eventOptions.map(function(ev) { return '<option value="' + ev + '">' + ev + '</option>'; }).join('');
                if (filterEvent.value !== eventFilter) filterEvent.value = eventFilter;

                contentEl.innerHTML = '<div class="feedback-card"><div class="feedback-table-wrap"><table class="feedback-table">' +
                    '<thead><tr><th>Event</th><th>Rating</th><th>Comment</th><th>Date</th></tr></thead><tbody>' +
                    filtered.map(function(row) {
                        return '<tr>' +
                            '<td>' + (row.event_name || '—') + '</td>' +
                            '<td class="rating-cell"><span class="rating-stars" title="' + row.rating + '">' + starString(row.rating) + '</span></td>' +
                            '<td class="comment-cell" title="' + (row.comment || '').replace(/"/g, '&quot;') + '">' + (row.comment || '—') + '</td>' +
                            '<td class="date-cell">' + formatDate(row.created_at) + '</td>' +
                            '</tr>';
                    }).join('') +
                    '</tbody></table></div></div>';
            }

            async function init() {
                try {
                    await loadMe();
                } catch (e) {
                    return;
                }

                logoutBtn.addEventListener('click', async function() {
                    try {
                        await fetch(base + '/api/staff/logout', { method: 'POST', credentials: 'include' });
                    } catch (_) {}
                    redirectToLogin();
                });

                filterEvent.addEventListener('change', function() {
                    if (window._feedbackRows) renderTable(window._feedbackRows);
                });

                try {
                    const rows = await loadFeedback();
                    window._feedbackRows = rows;
                    renderTable(rows);
                } catch (e) {
                    contentEl.innerHTML = '<div class="dashboard-error">Failed to load feedback.</div>';
                }
            }

            init();
        })();
    </script>
</body>
</html>
